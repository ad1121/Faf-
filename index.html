<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Monte seu Bolo - Fafa Bolos</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f8f8f8;
            min-height: 100vh;
            padding-bottom: 80px;
            transition: background 0.3s, color 0.3s;
        }

        .header {
            background: #fff;
            padding: 1.5rem 1rem;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            position: sticky;
            top: 0;
            z-index: 100;
            transition: background 0.3s;
        }

        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            max-width: 600px;
            margin: 0 auto;
        }

        .logo {
            font-size: 1.75rem;
            font-weight: 400;
            color: #ea1d2c;
            font-family: 'Georgia', 'Palatino', serif;
            letter-spacing: 0.5px;
            text-align: center;
            flex: 1;
            transition: color 0.3s;
        }

        .theme-toggle {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            padding: 0.5rem;
            border-radius: 50%;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .theme-toggle:hover {
            background: rgba(234, 29, 44, 0.1);
        }

        .container {
            padding: 1rem;
            max-width: 600px;
            margin: 0 auto;
        }

        .progress-bar {
            background: #fff;
            padding: 1rem;
            border-radius: 12px;
            margin-bottom: 1rem;
            box-shadow: 0 2px 8px rgba(0,0,0,0.06);
            transition: background 0.3s, box-shadow 0.3s;
        }

        .progress-steps {
            display: flex;
            align-items: center;
            justify-content: space-between;
            position: relative;
        }

        .progress-line {
            position: absolute;
            top: 18px;
            left: 40px;
            right: 40px;
            height: 2px;
            background: #e0e0e0;
            z-index: 0;
            transition: background 0.3s;
        }

        .progress-line-fill {
            height: 100%;
            background: #ea1d2c;
            transition: width 0.3s, background 0.3s;
        }

        .progress-step {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 0.5rem;
            position: relative;
            z-index: 1;
            min-width: 60px;
        }

        .step-circle {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background: #e0e0e0;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 0.875rem;
            color: #999;
            transition: all 0.3s;
        }

        .progress-step.active .step-circle {
            background: #ea1d2c;
            color: white;
        }

        .progress-step.completed .step-circle {
            background: #00a65a;
            color: white;
        }

        .step-label {
            font-size: 0.7rem;
            color: #666;
            font-weight: 500;
            text-align: center;
            min-height: 2.4rem;
            display: flex;
            align-items: center;
            justify-content: center;
            line-height: 1.2;
            transition: color 0.3s;
        }

        .progress-step.active .step-label {
            color: #ea1d2c;
            font-weight: 600;
        }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .section-title {
            font-size: 1.25rem;
            font-weight: 700;
            color: #333;
            transition: color 0.3s;
        }

        .btn-back {
            background: none;
            border: none;
            color: #ea1d2c;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            transition: color 0.3s;
        }

        .options-list {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
        }

        .option-item {
            background: #fff;
            border-radius: 12px;
            padding: 1.25rem;
            display: flex;
            gap: 1rem;
            cursor: pointer;
            transition: all 0.2s;
            border: 2px solid transparent;
            box-shadow: 0 2px 8px rgba(0,0,0,0.06);
        }

        .option-item:active {
            transform: scale(0.98);
        }

        .option-item.selected {
            border-color: #ea1d2c;
            background: #fff5f5;
        }

        .option-info {
            flex: 1;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }

        .option-name {
            font-size: 1rem;
            font-weight: 600;
            color: #333;
            margin-bottom: 0.25rem;
            transition: color 0.3s;
        }

        .option-description {
            font-size: 0.875rem;
            color: #666;
            margin-bottom: 0.5rem;
            transition: color 0.3s;
        }

        .option-price {
            font-size: 1.125rem;
            font-weight: 700;
            color: #ea1d2c;
            transition: color 0.3s;
        }

        .option-radio {
            width: 24px;
            height: 24px;
            border: 2px solid #ddd;
            border-radius: 50%;
            flex-shrink: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }

        .option-item.selected .option-radio {
            border-color: #ea1d2c;
            background: #ea1d2c;
        }

        .option-item.selected .option-radio::after {
            content: '‚úì';
            color: white;
            font-size: 0.875rem;
            font-weight: 700;
        }

        .bottom-bar {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: #fff;
            padding: 1rem;
            box-shadow: 0 -2px 12px rgba(0,0,0,0.1);
            z-index: 99;
            transition: background 0.3s, box-shadow 0.3s;
        }

        .bottom-content {
            max-width: 600px;
            margin: 0 auto;
            display: flex;
            gap: 1rem;
            align-items: center;
        }

        .total-info {
            flex: 1;
        }

        .total-label {
            font-size: 0.75rem;
            color: #666;
            margin-bottom: 0.25rem;
            transition: color 0.3s;
        }

        .total-price {
            font-size: 1.5rem;
            font-weight: 700;
            color: #333;
            transition: color 0.3s;
        }

        .btn-continue {
            padding: 1rem 2rem;
            background: #ea1d2c;
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 1rem;
            font-weight: 700;
            cursor: pointer;
            white-space: nowrap;
            transition: all 0.2s;
        }

        .btn-continue:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        .btn-continue:active:not(:disabled) {
            transform: scale(0.95);
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            transition: background 0.3s;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: #fff;
            border-radius: 20px;
            padding: 1.5rem;
            width: 90%;
            max-width: 500px;
            max-height: 90vh;
            overflow-y: auto;
            animation: slideUp 0.3s;
            transition: background 0.3s;
        }

        @keyframes slideUp {
            from { opacity: 0; transform: scale(0.95); }
            to { opacity: 1; transform: scale(1); }
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }

        .modal-title {
            font-size: 1.25rem;
            font-weight: 700;
            transition: color 0.3s;
        }

        .close-btn {
            background: none;
            border: none;
            font-size: 1.5rem;
            color: #666;
            cursor: pointer;
            padding: 0.5rem;
            transition: color 0.3s;
        }

        .summary-item {
            padding: 1rem;
            background: #f8f8f8;
            border-radius: 8px;
            margin-bottom: 0.75rem;
            transition: background 0.3s;
        }

        .summary-label {
            font-size: 0.875rem;
            color: #666;
            margin-bottom: 0.25rem;
            transition: color 0.3s;
        }

        .summary-value {
            font-size: 1rem;
            font-weight: 600;
            color: #333;
            transition: color 0.3s;
        }

        .payment-notice {
            background: #fff3cd;
            border-left: 4px solid #f39c12;
            padding: 1rem;
            border-radius: 8px;
            margin: 1rem 0;
            font-size: 0.875rem;
            color: #856404;
            transition: background 0.3s, color 0.3s;
        }

        .btn-whatsapp {
            width: 100%;
            padding: 1rem;
            background: #25D366;
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 1rem;
            font-weight: 700;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
        }

        .hidden {
            display: none !important;
        }

        .step-content {
            animation: fadeIn 0.3s;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .loading {
            text-align: center;
            padding: 2rem;
            color: #666;
            transition: color 0.3s;
        }

        .summary-name {
            flex: 1;
        }

        .summary-price {
            font-weight: 700;
            color: #ea1d2c;
            white-space: nowrap;
            transition: color 0.3s;
        }

        .summary-item-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 1rem;
        }

        /* Dark Mode */
        body.dark-mode {
            background: #1a1a1a;
            color: #e0e0e0;
        }

        body.dark-mode .header {
            background: #2d2d2d;
        }

        body.dark-mode .logo {
            color: #ff4757;
        }

        body.dark-mode .progress-bar,
        body.dark-mode .option-item,
        body.dark-mode .bottom-bar,
        body.dark-mode .modal-content {
            background: #2d2d2d;
        }

        body.dark-mode .section-title,
        body.dark-mode .option-name,
        body.dark-mode .total-price,
        body.dark-mode .summary-value,
        body.dark-mode .modal-title {
            color: #e0e0e0;
        }

        body.dark-mode .option-description,
        body.dark-mode .step-label,
        body.dark-mode .total-label,
        body.dark-mode .summary-label,
        body.dark-mode .loading,
        body.dark-mode .close-btn {
            color: #999;
        }

        body.dark-mode .option-item {
            box-shadow: 0 2px 8px rgba(0,0,0,0.3);
        }

        body.dark-mode .option-item.selected {
            background: #3d1f1f;
        }

        body.dark-mode .option-radio {
            border-color: #555;
        }

        body.dark-mode .summary-item {
            background: #1a1a1a;
        }

        body.dark-mode .payment-notice {
            background: #3d3419;
            border-left-color: #f39c12;
            color: #f5d576;
        }

        body.dark-mode .step-circle {
            background: #444;
            color: #999;
        }

        body.dark-mode .progress-step.active .step-circle {
            background: #ff4757;
        }

        body.dark-mode .progress-line {
            background: #444;
        }

        body.dark-mode .progress-line-fill {
            background: #ff4757;
        }

        body.dark-mode .btn-continue:not(:disabled) {
            background: #ff4757;
        }

        body.dark-mode .modal {
            background: rgba(0,0,0,0.8);
        }

        body.dark-mode .option-price,
        body.dark-mode .summary-price {
            color: #ff4757;
        }

        body.dark-mode .btn-back {
            color: #ff4757;
        }

        body.dark-mode .progress-step.active .step-label {
            color: #ff4757;
        }

        body.dark-mode .theme-toggle:hover {
            background: rgba(255, 71, 87, 0.1);
        }

        .confirm-modal-text {
            font-size: 1rem;
            color: #666;
            line-height: 1.6;
            margin: 1rem 0;
        }

        .confirm-modal-highlight {
            background: #fff5f5;
            border-left: 3px solid #ea1d2c;
            padding: 0.75rem 1rem;
            margin: 1rem 0;
            border-radius: 4px;
        }

        body.dark-mode .confirm-modal-text {
            color: #999;
        }

        body.dark-mode .confirm-modal-highlight {
            background: #3d1f1f;
            border-left-color: #ff4757;
        }

        .modal-buttons {
            display: flex;
            gap: 0.75rem;
            margin-top: 1.5rem;
        }

        .btn-modal {
            flex: 1;
            padding: 1rem;
            border: none;
            border-radius: 12px;
            font-size: 1rem;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-modal-secondary {
            background: #f0f0f0;
            color: #333;
        }

        .btn-modal-secondary:active {
            transform: scale(0.95);
        }

        body.dark-mode .btn-modal-secondary {
            background: #3a3a3a;
            color: #e0e0e0;
        }

        .btn-modal-primary {
            background: #ea1d2c;
            color: white;
        }

        .btn-modal-primary:active {
            transform: scale(0.95);
        }

        body.dark-mode .btn-modal-primary {
            background: #ff4757;
        }

        .form-group {
            margin-bottom: 1.5rem;
        }

        .form-label {
            display: block;
            font-size: 0.875rem;
            font-weight: 600;
            color: #333;
            margin-bottom: 0.5rem;
        }

        body.dark-mode .form-label {
            color: #e0e0e0;
        }

        .form-input,
        .form-textarea {
            width: 100%;
            padding: 0.75rem;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 1rem;
            font-family: inherit;
            transition: border-color 0.2s;
        }

        .form-input:focus,
        .form-textarea:focus {
            outline: none;
            border-color: #ea1d2c;
        }

        .form-textarea {
            resize: vertical;
            min-height: 100px;
        }

        body.dark-mode .form-input,
        body.dark-mode .form-textarea {
            background: #2d2d2d;
            border-color: #444;
            color: #e0e0e0;
        }

        body.dark-mode .form-input:focus,
        body.dark-mode .form-textarea:focus {
            border-color: #ff4757;
        }

        .form-note {
            font-size: 0.75rem;
            color: #999;
            margin-top: 0.25rem;
        }
    </style>
</head>
<body>
    <header class="header">
        <div class="header-content">
            <button class="theme-toggle" onclick="toggleTheme()" title="Alternar tema">
                <span id="themeIcon">üåô</span>
            </button>
            <div class="logo">üéÇ Fafa Bolos</div>
            <div style="width: 40px;"></div>
        </div>
    </header>

    <div class="container">
        <div id="clientPage">
            <div class="progress-bar">
                <div class="progress-steps" id="progressSteps"></div>
            </div>
            <div id="stepContents"></div>
        </div>
    </div>

    <div class="bottom-bar" id="bottomBar">
        <div class="bottom-content">
            <div class="total-info">
                <div class="total-label">Total</div>
                <div class="total-price" id="totalPrice">R$ 0,00</div>
            </div>
            <button class="btn-continue" id="continueBtn" onclick="handleContinue()" disabled>Continuar</button>
        </div>
    </div>

    <div class="modal" id="summaryModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Resumo do Pedido</h3>
                <button class="close-btn" onclick="closeModal('summaryModal')">‚úï</button>
            </div>
            <div id="summaryItems"></div>
            <div class="payment-notice">
                <strong>‚ö†Ô∏è Importante:</strong> Pagamento de 50% como sinal. O restante na entrega.
            </div>
            <div style="text-align:center;margin:1rem 0">
                <div style="font-size:0.875rem;color:#666">Valor Total</div>
                <div style="font-size:2rem;font-weight:700;color:#ea1d2c" id="summaryTotal">R$ 0,00</div>
            </div>
            <button class="btn-whatsapp" onclick="showDeliveryForm()">Continuar ‚ûú</button>
        </div>
    </div>

    <div class="modal" id="confirmRecheioModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">üåü Recheio Especial</h3>
            </div>
            <div class="confirm-modal-text">
                Voc√™ j√° escolheu o recheio:
            </div>
            <div class="confirm-modal-highlight">
                <strong id="currentRecheioName"></strong>
            </div>
            <div class="confirm-modal-text">
                Deseja trocar por um <strong>recheio especial</strong>? O recheio tradicional ser√° substitu√≠do.
            </div>
            <div class="modal-buttons">
                <button class="btn-modal btn-modal-secondary" onclick="skipSpecialRecheio()">N√£o, obrigado</button>
                <button class="btn-modal btn-modal-primary" onclick="continueToSpecialRecheio()">Sim, quero especial!</button>
            </div>
        </div>
    </div>

    <div class="modal" id="deliveryModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">üìÖ Detalhes da Entrega</h3>
                <button class="close-btn" onclick="closeModal('deliveryModal')">‚úï</button>
            </div>
            
            <div class="form-group">
                <label class="form-label" for="deliveryDate">Data de Entrega *</label>
                <input type="date" id="deliveryDate" class="form-input" required>
                <div class="form-note">Escolha a data desejada para receber seu bolo</div>
            </div>

            <div class="form-group">
                <label class="form-label" for="deliveryComments">Observa√ß√µes (Opcional)</label>
                <textarea id="deliveryComments" class="form-textarea" placeholder="Ex: Entregar ap√≥s 15h, escrever 'Parab√©ns Maria' no bolo..."></textarea>
                <div class="form-note">Adicione qualquer informa√ß√£o importante sobre seu pedido</div>
            </div>

            <button class="btn-whatsapp" onclick="sendWhatsApp()">üì± Fazer Pedido pelo WhatsApp</button>
        </div>
    </div>

    <script>
        let currentStepIndex = 0;
        let groups = [];
        let items = [];
        let selections = {};
        let deliveryInfo = { date: '', comments: '' };
        let WHATSAPP_NUMBER = '5561991813043';
        const SHEET_URL = 'https://docs.google.com/spreadsheets/d/1sY4UdcXWEmLS-dvgKibR6s9TdFUdU_24L5qm0fuP2So/edit';

        async function loadData() {
            const synced = await syncWithSheet(true);
            if (!synced) {
                groups = [
                    { id: 4, nome: 'Kg do Bolo', icone: '‚öñÔ∏è', ordem: 1, obrigatorio: true },
                    { id: 1, nome: 'Massas', icone: 'ü•û', ordem: 2, obrigatorio: true },
                    { id: 2, nome: 'Recheios Tradicionais', icone: 'üçØ', ordem: 3, obrigatorio: true, grupoAlternativo: 5 },
                    { id: 5, nome: 'Recheios Especiais', icone: 'üåü', ordem: 4, obrigatorio: false, grupoAlternativo: 2 },
                    { id: 3, nome: 'Adicional', icone: 'üé®', ordem: 5, obrigatorio: true }
                ];
                items = [
                    { id: 1, grupoId: 4, nome: '1 Kg', descricao: 'Serve at√© 10 pessoas', preco: 85 },
                    { id: 2, grupoId: 4, nome: '2 Kg', descricao: 'Serve at√© 20 pessoas', preco: 170 },
                    { id: 3, grupoId: 1, nome: 'Chocolate', descricao: 'Massa de chocolate', preco: 0 },
                    { id: 4, grupoId: 1, nome: 'Branca', descricao: 'Massa branca', preco: 0 },
                    { id: 5, grupoId: 2, nome: 'Brigadeiro', descricao: 'Recheio de brigadeiro', preco: 0 },
                    { id: 6, grupoId: 2, nome: 'Doce de Leite', descricao: 'Recheio de doce de leite', preco: 0 },
                    { id: 7, grupoId: 5, nome: 'Ninho c/ Abacaxi', descricao: 'Recheio especial', preco: 10 },
                    { id: 8, grupoId: 5, nome: 'Maracuj√°', descricao: 'Recheio de maracuj√°', preco: 10 },
                    { id: 9, grupoId: 3, nome: 'P√≥ Colorido', descricao: 'Adicional decorativo', preco: 10 },
                    { id: 10, grupoId: 3, nome: 'Glitter', descricao: 'Adicional brilhante', preco: 12 },
                    { id: 11, grupoId: 3, nome: 'Sem Adicional', descricao: 'Sem adicional', preco: 0 }
                ];
            }
            WHATSAPP_NUMBER = localStorage.getItem('whatsappNumber') || '5561991813043';
        }

        function getGroupsByOrder() {
            return groups.sort((a, b) => a.ordem - b.ordem);
        }

        function getItemsByGroup(groupId) {
            let groupItems = items.filter(item => item.grupoId === groupId);
            
            // Se for grupo de adicional, coloca "Sem Adicional" primeiro
            const group = groups.find(g => g.id === groupId);
            if (group && group.nome.toLowerCase().includes('adicional')) {
                return groupItems.sort((a, b) => {
                    if (a.nome.toLowerCase().includes('sem')) return -1;
                    if (b.nome.toLowerCase().includes('sem')) return 1;
                    return 0;
                });
            }
            
            return groupItems;
        }

        function buildClientInterface() {
            const orderedGroups = getGroupsByOrder();
            const progressSteps = document.getElementById('progressSteps');
            
            progressSteps.innerHTML = `
                <div class="progress-line">
                    <div class="progress-line-fill" id="progressFill" style="width:0%"></div>
                </div>
                ${orderedGroups.map((group, index) => {
                    let stepLabel = group.nome;
                    // Converte "Massas" para "Massa"
                    if (stepLabel.toLowerCase() === 'massas') {
                        stepLabel = 'Massa';
                    }
                    return `
                    <div class="progress-step ${index === 0 ? 'active' : ''}" data-step="${index}">
                        <div class="step-circle">${index + 1}</div>
                        <div class="step-label">${stepLabel}</div>
                    </div>
                `}).join('')}
            `;
            
            const stepContents = document.getElementById('stepContents');
            stepContents.innerHTML = orderedGroups.map((group, index) => {
                const hasSelection = selections[group.id];
                
                // Ajusta o texto do t√≠tulo
                let titleText = group.nome;
                if (titleText.toLowerCase() === 'massas') {
                    titleText = 'a Massa do Bolo';
                } else if (titleText.toLowerCase().includes('recheios tradicionais')) {
                    titleText = 'o Recheio Tradicional';
                } else if (titleText.toLowerCase().includes('recheios especiais')) {
                    titleText = 'o Recheio Especial';
                } else if (titleText.toLowerCase().includes('kg do bolo')) {
                    titleText = titleText;
                } else if (titleText.toLowerCase().includes('adicional')) {
                    titleText = titleText;
                } else {
                    titleText = group.nome;
                }
                
                return `
                <div id="step${index}" class="step-content ${index !== 0 ? 'hidden' : ''}">
                    <div class="section-header">
                        <h2 class="section-title">Escolha ${titleText}</h2>
                        ${index > 0 ? '<button class="btn-back" onclick="goBack()">‚Üê Voltar</button>' : ''}
                    </div>
                    ${!group.obrigatorio && !hasSelection ? `
                        <div style="text-align: center; margin-bottom: 1rem;" id="skipButton${index}">
                            <button class="btn-continue" onclick="skipStep()" style="background: #666; width: auto; padding: 0.75rem 1.5rem;">
                                Pular esta etapa
                            </button>
                        </div>
                    ` : ''}
                    <div class="options-list" id="options${index}"></div>
                </div>
            `}).join('');
        }

        function renderClientOptions() {
            getGroupsByOrder().forEach((group, index) => {
                renderOptions(getItemsByGroup(group.id), `options${index}`, index, group.id);
            });
        }

        function renderOptions(itemsList, containerId, stepIndex, groupId) {
            const container = document.getElementById(containerId);
            if (!container) return;
            
            const selected = selections[groupId];
            
            container.innerHTML = itemsList.length > 0 ? itemsList.map(item => `
                <div class="option-item ${selected?.id === item.id ? 'selected' : ''}" 
                     onclick="selectItem(${groupId}, ${item.id}, ${stepIndex})">
                    <div class="option-info">
                        <div class="option-name">${item.nome}</div>
                        <div class="option-description">${item.descricao}</div>
                        ${item.preco > 0 ? `<div class="option-price">R$ ${item.preco.toFixed(2)}</div>` : ''}
                    </div>
                    <div class="option-radio"></div>
                </div>
            `).join('') : '<div class="loading">Nenhum item dispon√≠vel</div>';
        }

        function selectItem(groupId, itemId, stepIndex) {
            const item = items.find(i => i.id === itemId);
            const currentGroup = groups.find(g => g.id === groupId);
            
            if (currentGroup && currentGroup.grupoAlternativo) {
                const altGroupId = currentGroup.grupoAlternativo;
                if (selections[altGroupId]) {
                    delete selections[altGroupId];
                }
            }
            
            selections[groupId] = item;
            
            if (!currentGroup.obrigatorio) {
                const skipButton = document.getElementById(`skipButton${stepIndex}`);
                if (skipButton) {
                    skipButton.style.display = 'none';
                }
            }
            
            renderOptions(getItemsByGroup(groupId), `options${stepIndex}`, stepIndex, groupId);
            updateBottomBar();
        }

        function updateBottomBar() {
            let total = 0;
            Object.values(selections).forEach(item => {
                if (item && item.preco) total += parseFloat(item.preco);
            });
            
            document.getElementById('totalPrice').textContent = `R$ ${total.toFixed(2)}`;
            
            const continueBtn = document.getElementById('continueBtn');
            const orderedGroups = getGroupsByOrder();
            const currentGroup = orderedGroups[currentStepIndex];
            
            if (currentGroup && (!currentGroup.obrigatorio || selections[currentGroup.id])) {
                continueBtn.disabled = false;
                if (currentStepIndex === orderedGroups.length - 1) {
                    continueBtn.textContent = 'Ver Resumo';
                } else {
                    continueBtn.textContent = 'Continuar';
                }
            } else {
                continueBtn.disabled = true;
            }
        }

        function skipStep() {
            const orderedGroups = getGroupsByOrder();
            const currentGroup = orderedGroups[currentStepIndex];
            
            if (currentGroup && selections[currentGroup.id]) {
                delete selections[currentGroup.id];
            }
            
            handleContinue();
        }

        function handleContinue() {
            const orderedGroups = getGroupsByOrder();
            
            // Se est√° indo para recheios especiais E j√° tem recheio tradicional selecionado
            if (currentStepIndex < orderedGroups.length - 1) {
                const nextGroup = orderedGroups[currentStepIndex + 1];
                const currentGroup = orderedGroups[currentStepIndex];
                
                // Verifica se o pr√≥ximo grupo √© "Recheios Especiais" (ou tem grupo alternativo)
                if (nextGroup.grupoAlternativo && selections[nextGroup.grupoAlternativo]) {
                    // Mostra confirma√ß√£o
                    const currentRecheio = selections[nextGroup.grupoAlternativo];
                    document.getElementById('currentRecheioName').textContent = currentRecheio.nome;
                    document.getElementById('confirmRecheioModal').classList.add('active');
                    return;
                }
                
                currentStepIndex++;
                showStepContent(currentStepIndex);
            } else {
                showSummary();
            }
        }

        function skipSpecialRecheio() {
            closeModal('confirmRecheioModal');
            // Pula o grupo de recheios especiais
            currentStepIndex += 2; // Pula especiais e vai direto pro pr√≥ximo
            const orderedGroups = getGroupsByOrder();
            if (currentStepIndex >= orderedGroups.length) {
                showSummary();
            } else {
                showStepContent(currentStepIndex);
            }
        }

        function continueToSpecialRecheio() {
            closeModal('confirmRecheioModal');
            currentStepIndex++;
            showStepContent(currentStepIndex);
        }

        function goBack() {
            if (currentStepIndex > 0) {
                currentStepIndex--;
                showStepContent(currentStepIndex);
            }
        }

        function showStepContent(stepIndex) {
            currentStepIndex = stepIndex;
            const orderedGroups = getGroupsByOrder();
            
            orderedGroups.forEach((group, index) => {
                const stepElement = document.getElementById(`step${index}`);
                if (stepElement) {
                    stepElement.classList.toggle('hidden', index !== stepIndex);
                }
                
                if (!group.obrigatorio) {
                    const skipButton = document.getElementById(`skipButton${index}`);
                    if (skipButton) {
                        skipButton.style.display = selections[group.id] ? 'none' : 'block';
                    }
                }
            });
            
            const steps = document.querySelectorAll('.progress-step');
            steps.forEach((s, index) => {
                s.classList.remove('active', 'completed');
                if (index === stepIndex) {
                    s.classList.add('active');
                } else if (index < stepIndex) {
                    s.classList.add('completed');
                }
            });
            
            const progress = orderedGroups.length > 1 ? (stepIndex / (orderedGroups.length - 1)) * 100 : 0;
            const progressFill = document.getElementById('progressFill');
            if (progressFill) {
                progressFill.style.width = progress + '%';
            }
            
            updateBottomBar();
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        function showSummary() {
            const orderedGroups = getGroupsByOrder();
            const summaryItems = document.getElementById('summaryItems');
            
            summaryItems.innerHTML = orderedGroups.map(group => {
                const item = selections[group.id];
                if (!item && !group.obrigatorio) return '';
                
                // Ajusta o nome do grupo se for massa (singular)
                let groupName = group.nome;
                if (group.nome.toLowerCase().includes('massa')) {
                    groupName = 'Massa';
                }
                
                return `
                    <div class="summary-item">
                        <div class="summary-label">${group.icone} ${groupName}</div>
                        <div class="summary-item-content">
                            <div class="summary-name">${item ? item.nome : '-'}</div>
                            ${item && item.preco > 0 ? `<div class="summary-price">R$ ${item.preco.toFixed(2)}</div>` : ''}
                        </div>
                    </div>
                `;
            }).join('');
            
            let total = 0;
            Object.values(selections).forEach(item => {
                if (item && item.preco) total += parseFloat(item.preco);
            });
            
            document.getElementById('summaryTotal').textContent = `R$ ${total.toFixed(2)}`;
            document.getElementById('summaryModal').classList.add('active');
        }

        function showDeliveryForm() {
            closeModal('summaryModal');
            // Define data m√≠nima como amanh√£
            const tomorrow = new Date();
            tomorrow.setDate(tomorrow.getDate() + 1);
            document.getElementById('deliveryDate').min = tomorrow.toISOString().split('T')[0];
            document.getElementById('deliveryModal').classList.add('active');
        }

        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('active');
        }

        function sendWhatsApp() {
            const deliveryDate = document.getElementById('deliveryDate').value;
            
            if (!deliveryDate) {
                alert('Por favor, selecione a data de entrega');
                return;
            }
            
            const deliveryComments = document.getElementById('deliveryComments').value;
            
            let total = 0;
            let message = 'üéÇ *Novo Pedido - Fafa Bolos*\n\n';
            message += '*MEU BOLO PERSONALIZADO:*\n\n';
            
            const orderedGroups = getGroupsByOrder();
            orderedGroups.forEach(group => {
                const item = selections[group.id];
                if (item) {
                    let groupName = group.nome;
                    if (group.nome.toLowerCase().includes('massa')) {
                        groupName = 'Massa';
                    }
                    
                    message += `${group.icone} *${groupName}:* ${item.nome}\n`;
                    if (item.preco > 0) {
                        message += `   R$ ${item.preco.toFixed(2)}\n\n`;
                        total += parseFloat(item.preco);
                    } else {
                        message += '\n';
                    }
                }
            });
            
            const sinal = total * 0.5;
            message += `‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n`;
            message += `üí∞ *VALOR TOTAL: R$ ${total.toFixed(2)}*\n\n`;
            
            // Adiciona data de entrega
            const [year, month, day] = deliveryDate.split('-');
            message += `üìÖ *Data de Entrega:* ${day}/${month}/${year}\n\n`;
            
            // Adiciona observa√ß√µes se houver
            if (deliveryComments.trim()) {
                message += `üìù *Observa√ß√µes:*\n${deliveryComments.trim()}\n\n`;
            }
            
            message += `‚ö†Ô∏è *IMPORTANTE:*\n`;
            message += `üìå Sinal de 50%: *R$ ${sinal.toFixed(2)}*\n`;
            message += `üìå Restante na entrega: R$ ${(total - sinal).toFixed(2)}`;

            const url = `https://wa.me/${WHATSAPP_NUMBER}?text=${encodeURIComponent(message)}`;
            window.open(url, '_blank');
        }

        async function syncWithSheet(silent = false) {
            try {
                const sheetId = SHEET_URL.match(/\/spreadsheets\/d\/([a-zA-Z0-9-_]+)/)?.[1];
                if (!sheetId) return false;

                const gruposUrl = `https://docs.google.com/spreadsheets/d/${sheetId}/gviz/tq?tqx=out:json&sheet=Grupos`;
                const itensUrl = `https://docs.google.com/spreadsheets/d/${sheetId}/gviz/tq?tqx=out:json&sheet=Itens`;

                const gruposResponse = await fetch(gruposUrl);
                const gruposText = await gruposResponse.text();
                const gruposJson = JSON.parse(gruposText.substring(47).slice(0, -2));

                const itensResponse = await fetch(itensUrl);
                const itensText = await itensResponse.text();
                const itensJson = JSON.parse(itensText.substring(47).slice(0, -2));

                groups = gruposJson.table.rows.map(row => ({
                    id: parseInt(row.c[0]?.v || 0),
                    nome: row.c[1]?.v || '',
                    icone: row.c[2]?.v || 'üì¶',
                    ordem: parseInt(row.c[3]?.v || 1),
                    obrigatorio: row.c[4]?.v !== false,
                    grupoAlternativo: parseInt(row.c[5]?.v || 0) || null
                })).filter(g => g.id > 0);

                items = itensJson.table.rows.map(row => ({
                    id: parseInt(row.c[0]?.v || 0),
                    grupoId: parseInt(row.c[1]?.v || 0),
                    nome: row.c[2]?.v || '',
                    descricao: row.c[3]?.v || '',
                    preco: parseFloat(row.c[4]?.v || 0)
                })).filter(i => i.id > 0);

                buildClientInterface();
                renderClientOptions();

                return true;
            } catch (error) {
                console.error('Erro na sincroniza√ß√£o:', error);
                return false;
            }
        }

        function openImagePreview(imageUrl, imageName) {
            const modal = document.getElementById('imagePreviewModal');
            const img = document.getElementById('previewImage');
            img.src = imageUrl;
            img.alt = imageName;
            modal.classList.add('active');
            document.body.style.overflow = 'hidden';
        }

        function closeImagePreview(event) {
            if (event.target.id === 'imagePreviewModal' || event.target.classList.contains('image-preview-close')) {
                const modal = document.getElementById('imagePreviewModal');
                modal.classList.remove('active');
                document.body.style.overflow = '';
            }
        }

        function toggleTheme() {
            const body = document.body;
            const themeIcon = document.getElementById('themeIcon');
            
            body.classList.toggle('dark-mode');
            
            if (body.classList.contains('dark-mode')) {
                themeIcon.textContent = '‚òÄÔ∏è';
                localStorage.setItem('theme', 'dark');
            } else {
                themeIcon.textContent = 'üåô';
                localStorage.setItem('theme', 'light');
            }
        }

        function loadTheme() {
            const savedTheme = localStorage.getItem('theme');
            const themeIcon = document.getElementById('themeIcon');
            
            if (savedTheme === 'dark') {
                document.body.classList.add('dark-mode');
                themeIcon.textContent = '‚òÄÔ∏è';
            }
        }

        window.onclick = function(event) {
            if (event.target.classList.contains('modal')) {
                event.target.classList.remove('active');
            }
        };

        (async function init() {
            loadTheme();
            await loadData();
            buildClientInterface();
            renderClientOptions();
        })();
    </script>
</body>
</html>

